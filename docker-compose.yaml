x-wharfmap:
  profiles:
    setup:
      color: "#E8F5E9"
      border-color: "#2E7D32"
      border-width: "2px"
    classifier:
      color: "#FFF3E0"
      border-color: "#E65100"
      border-width: "2px"
  conditions:
    service_healthy:
      # stroke: "#000000ff"
      stroke-width: "2px"
      stroke-dasharray: "5 5"
      # color: "#000000ff"

services:
  postgres:
    image: postgres:15
    command: [ "postgres", "-c", "logging_collector=off", "-c", "log_statement=none", "-c", "log_min_messages=fatal" ]
    container_name: pkmn-db
    environment:
      POSTGRES_USER: pkmn
      POSTGRES_PASSWORD: pkmn
      POSTGRES_DB: pokedex
    ports:
      - "5432:5432"
    volumes:
      - pkmn_data:/var/lib/postgresql/data
      - ./database-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "sh -c 'pg_isready -U pkmn -d pokedex'"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - web
    x-wharfmap:
      color: "#BBDEFB"
      border-color: "#1976D2"
      border-width: "3px"
      border-style: "dashed"

  pkmn-fetcher:
    build: pkmn-data-retrieval/.
    container_name: pkmn-fetcher
    restart: "no"
    profiles:
      - setup
    volumes:
      - ./pkmn-data-retrieval/src:/app/src
    depends_on:
      postgres:
        condition: service_healthy # Wait for PostgreSQL to be ready
    networks:
      - web
    x-wharfmap:
      color: "#C8E6C9"
      border-color: "#388E3C"
      border-width: "3px"

  zookeeper:
    image: confluentinc/cp-zookeeper:7.9.1
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
      ZOOKEEPER_MAX_CLIENT_CNXNS: 60
      ZOOKEEPER_LOG4J_ROOT_LOGLEVEL: "ERROR"
      ZOOKEEPER_LOG4J_LOGGERS: "org.apache.zookeeper=ERROR"
    ports:
      - "2181:2181"
    profiles:
      - classifier
    healthcheck:
      test: ["CMD-SHELL", "echo srvr | nc localhost 2181 | grep Zookeeper"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - web
    x-wharfmap:
      color: "#E1BEE7"
      border-color: "#7B1FA2"
      border-width: "3px"

  kafka:
    image: confluentinc/cp-kafka:7.9.1
    container_name: kafka
    restart: unless-stopped
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_MESSAGE_MAX_BYTES: 10485760
      KAFKA_REPLICA_FETCH_MAX_BYTES: 10485760
      KAFKA_MAX_REQUEST_SIZE: 10485760
      KAFKA_LOG4J_ROOT_LOGLEVEL: "WARN"
      KAFKA_LOG4J_LOGGERS: "kafka.controller=ERROR,state.change.logger=ERROR"
      KAFKA_LOG4J_OPTS: "-Dlog4j.configuration=file:/app/kafka-log4j.properties"
    volumes:
      - ./custom-log4j.properties:/app/kafka-log4j.properties:ro
    ports:
      - "29092:29092"
    profiles:
      - classifier
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 90s
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    networks:
      - web
    x-wharfmap:
      color: "#FFCCBC"
      border-color: "#E64A19"
      border-width: "3px"

  redis:
    image: redis:7-alpine
    container_name: redis
    profiles:
      - classifier
    ports:
      - "6379:6379"
    command: sh -c "echo 'Hello, Redis is starting!' && redis-server --appendonly yes --loglevel warning"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - web
    x-wharfmap:
      color: "#FFCDD2"
      border-color: "#C62828"
      border-width: "3px"

  pkmn-api:
    build: pkmn-api/.
    container_name: pkmn-api
    restart: on-failure:3
    profiles:
      - classifier
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_INPUT_TOPIC: pokemon-images
      KAFKA_OUTPUT_TOPIC: pokemon-results
      REDIS_HOST: redis
      REDIS_PORT: 6379
      DB_HOST: postgres
      DB_NAME: pokedex
      DB_USER: pkmn
      DB_PASSWORD: pkmn
      DB_PORT: 5432
    ports:
      - "8000:8000"
    volumes:
      - ./pkmn-api/src:/app/src
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30m   # extremely long â†’ practically never repeats
      timeout: 20s
      retries: 5
      start_period: 1s
    networks:
      - web
    x-wharfmap:
      color: "#FFE082"
      border-color: "#F57C00"
      border-width: "3px"

  pkmn-classifier:
    build: pkmn-classifier/.
    container_name: pkmn-classifier
    restart: on-failure:3
    profiles:
      - classifier
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_INPUT_TOPIC: pokemon-images
      KAFKA_OUTPUT_TOPIC: pokemon-results
      KAFKA_CONSUMER_GROUP: pokemon-classifier-group
      PYTHONUNBUFFERED: 1
    volumes:
      - ./pkmn-classifier/src:/app/src
      - ./pkmn-classifier/test:/app/test
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - web
    x-wharfmap:
      color: "#C5CAE9"
      border-color: "#303F9F"
      border-width: "3px"

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    profiles:
      - classifier
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      LOG_LEVEL: OFF
      LOGGING_LEVEL_ROOT: OFF
      LOGGING_LEVEL_COM_PROVECTUS: OFF
      LOGGING_LEVEL_REACTOR_CORE_PUBLISHER: OFF
      AUTH_TYPE: "LOGIN_FORM"
      SPRING_SECURITY_USER_NAME: ${KAFKA_UI_USER_NAME:-admin}
      SPRING_SECURITY_USER_PASSWORD: ${KAFKA_UI_USER_PASSWORD:-admin123}
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - web 
    x-wharfmap:
      color: "#E3F2FD"
      border-color: "#1976D2"
      border-width: "3px"

  nginx:
    image: nginx:stable-alpine
    container_name: nginx
    profiles:
      - classifier
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      pkmn-api:
        condition: service_healthy
    networks:
      - web
    x-wharfmap:
      color: "#FFF9C4"
      border-color: "#F57F17"
      border-width: "3px"

  ngrok:
    build:
      context: .
      dockerfile: Dockerfile.ngrok
    container_name: ngrok
    profiles:
      - classifier
    command: http nginx:80 --log=stdout
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN}
    depends_on:
      - nginx
    networks:
      - web
    x-wharfmap:
      color: "#D1C4E9"
      border-color: "#512DA8"
      border-width: "3px"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    ports:
      - "9443:9443"
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    restart: unless-stopped
    command: --log-level=ERROR
    networks:
      - web
    x-wharfmap:
      color: "#E1F5FE"
      border-color: "#0c4667ff"
      border-width: "3px"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_LOG_LEVEL=error
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - web
    depends_on:
      postgres:
        condition: service_healthy
    x-wharfmap:
      color: "#cc382b76"
      border-color: "#E65100"
      border-width: "3px"

volumes:
  pkmn_data:
  redis_data:
  portainer_data:
  grafana_data:

networks:
  web:
    driver: bridge
